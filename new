#!/bin/bash
set -euo pipefail

DAY="${1:-}"

if [ -z "$DAY" ]; then
  echo "Usage: ./new <DAY>" >&2
  exit 1
fi

DAY_DIR=$(printf "%02d" "$DAY")

if [ -d "$DAY_DIR" ]; then
  echo "Day $DAY_DIR already exists" >&2
  exit 1
fi

mkdir -p "$DAY_DIR/tests"
touch "$DAY_DIR/example" "$DAY_DIR/puzzle" "$DAY_DIR/custom"

cat > "$DAY_DIR/main.go" <<EOF
package day$DAY_DIR

import (
	"advent-of-code-2025/shared"
	"fmt"
)

const Day = "$DAY_DIR"

// ======================================================== //

var _debug bool

func DEBUG(a ...any) {
	if _debug {
		fmt.Fprint(os.Stderr, a...)
	}
}

func DEBUGF(format string, a ...any) {
	if _debug {
		fmt.Fprintf(os.Stderr, format, a...)
	}
}

// ======================================================== //

// Run executes both parts and returns their results.
func Run(debug bool, targetFile string) (int, int) {
	_debug = debug

	lines := shared.ReadLines(targetFile)

	var part01 int
	var part02 int

	fmt.Println(lines[0])

	fmt.Println(part01)
	fmt.Println(part02)

	return part01, part02
}
EOF

cat > "$DAY_DIR/main_test.go" <<EOF
package day$DAY_DIR

import "testing"

func TestExample(t *testing.T) {
	t.Skip("TODO: add example expectations")

	part01, part02 := Run(true, "example")
	var expected01 int
	var expected02 int

	if part01 != expected01 {
		t.Fatalf("Part 01: got %d, expected %d", part01, expected01)
	}

	if part02 != expected02 {
		t.Fatalf("Part 02: got %d, expected %d", part02, expected02)
	}
}

func TestPuzzle(t *testing.T) {
	t.Skip("TODO: add puzzle expectations")

	part01, part02 := Run(true, "puzzle")
	var expected01 int
	var expected02 int

	if part01 != expected01 {
		t.Fatalf("Part 01: got %d, expected %d", part01, expected01)
	}

	if part02 != expected02 {
		t.Fatalf("Part 02: got %d, expected %d", part02, expected02)
	}
}

func TestSamples(t *testing.T) {
	t.Skip("TODO: add test cases in tests/")

	part01, part02 := Run(true, "tests/01")
	var expected01 int
	var expected02 int

	if part01 != expected01 {
		t.Fatalf("Part 01: got %d, expected %d", part01, expected01)
	}

	if part02 != expected02 {
		t.Fatalf("Part 02: got %d, expected %d", part02, expected02)
	}
}
EOF

ENV_FILE=".env"
if [ ! -f "$ENV_FILE" ]; then
	cat > "$ENV_FILE" <<EOF
DAY=$DAY_DIR
DEBUG=yes
EOF
else
	if grep -q "^DAY=" "$ENV_FILE"; then
		sed -i "s/^DAY=.*/DAY=$DAY_DIR/" "$ENV_FILE"
	else
		echo "DAY=$DAY_DIR" >> "$ENV_FILE"
	fi
fi

echo "Created day $DAY_DIR"
